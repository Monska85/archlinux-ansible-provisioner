---
- name: Create an aur_builder user to install aur packages without password
  block:
  - name: Create the `aur_builder` user
    ansible.builtin.user:
      name: aur_builder
      create_home: yes
      group: wheel

  - name: Allow the `aur_builder` user to run `sudo pacman` without a password
    ansible.builtin.lineinfile:
      path: /etc/sudoers.d/11-install-aur_builder
      line: 'aur_builder ALL=(ALL) NOPASSWD: /usr/bin/pacman'
      create: yes
      validate: 'visudo -cf %s'

  - name: Allow the `aur_builder` user to run `sudo makepkg` without a password
    ansible.builtin.lineinfile:
      path: /etc/sudoers.d/11-install-aur_builder
      line: 'aur_builder ALL=(ALL) NOPASSWD: /usr/bin/makepkg'
      create: yes
      validate: 'visudo -cf %s'

- name: Install paru
  block:
    - name: Checkout paru
      ansible.builtin.git:
        repo: 'https://aur.archlinux.org/paru.git'
        dest: /tmp/paru
      become: yes
      become_user: aur_builder
    - name: Build and install paru
      shell: makepkg -si --noconfirm
      args:
        chdir: /tmp/paru
      become: yes
      become_user: aur_builder

- name: Configure system components
  tags: [ system, bluetooth ]
  block:
  - name: Install bluetooth dependencies
    community.general.pacman:
      name:
        - bluez
        - bluez-utils
  - name: Activate bluetooth service
    command: systemctl enable bluetooth
  - name: Enable sshd.service
    shell: systemctl enable sshd

- name: Install cloud native packages
  tags: [ cloudnative, packages ]
  block:
    - name: Install cloud native packages
      community.general.pacman:
        name:
          - aws-cli
          - google-cloud-sdk
          - kubectl
          - helm
    - name: Install cloud native packages from aur
      kewlfft.aur.aur:
        use: paru
        name:
          - kind
          - kubectx
          - stern
      become: yes
      become_user: aur_builder
    - name: Install docker
      community.general.pacman:
        name:
          - docker
          - docker-compose
    - name: Add user paolo to docker group
      user:
        name: '{{ username }}'
        groups: docker
        append: yes
    - name: Enable docker service
      shell: systemctl enable docker

- name: Install base packages
  block:
  - name: Install base packages
    community.general.pacman:
      name:
        - git
        - base-devel
        - dnsutils
        - dhcpcd
        - deja-dup
        - firefox
        - guvcview
        - htop
        - pacman-contrib
        - iproute2
        - neofetch
        - net-tools
        - dialog
        - wpa_supplicant
        - zsh
        - thefuck
        - tmux
        - telegram-desktop
  - name: Install base packages from aur
    kewlfft.aur.aur:
      use: paru
      name:
        - google-chrome
        - slack-desktop
        - timeshift
        - visual-studio-code-bin
        - zoom
    become: yes
    become_user: aur_builder

- name: Install logitech stuff
  block:
  - name: Install logitech packages
    community.general.pacman:
      name:
        - solaar
  - name: Install logitech packages from aur
    kewlfft.aur.aur:
      use: paru
      name:
        - logiops
    become: yes
    become_user: aur_builder
  - name: Configure logiops (for MX Master 2S)
    ansible.builtin.copy:
      src: logitech/logid-mx-master2s.cfg
      dest: /etc/logid.cfg

- name: Install fonts
  community.general.pacman:
    name:
      - ttf-anonymous-pro
      - ttf-droid
      - ttf-fira-code
      - ttf-fira-mono
      - ttf-fira-sans
      - ttf-jetbrains-mono
      - ttf-lato
      - ttf-roboto
      - ttf-roboto-mono
      - ttf-ubuntu-font-family

- name: Install gnome
  block:
    - name: Install packages
      community.general.pacman:
        name:
          - gdm
          - xorg
          - gnome
          - gnome-extra
          - gnome-shell-extension-appindicator
          - power-profiles-daemon
          - networkmanager
          - ntfs-3g
          - xorg-server
        state: present
        update_cache: yes
    - name: Install gnome aur dependencies
      kewlfft.aur.aur:
        use: paru
        name:
          - gnome-shell-extension-just-perfection-desktop-git
      become: yes
      become_user: aur_builder
    - name: "Enable gdm"
      shell: systemctl enable gdm
    - name: "Enable NetworkManager"
      shell: systemctl enable NetworkManager
    - name: "Enable power-profiles-daemon"
      shell: systemctl enable power-profiles-daemon

- name: Install nvidia drivers
  community.general.pacman:
    name:
      - nvidia
      - nvidia-settings
      - nvidia-utils
    state: present
    update_cache: yes

- name: Install pipewire audio
  block:
    - name: Install pipewire packages (to replace Pulseaudio)
      shell: yes | pacman -Syu pipewire-pulse # there isn't a way to install conflicting packages.


- name: Configure grub to print OEM logo
  tags: grub
  block:
  - name: "Checking GRUB cmdline"
    shell: "grep 'GRUB_CMDLINE_LINUX_DEFAULT=.*splash.*' /etc/default/grub"
    register: grub_cfg_grep
    changed_when: false
    failed_when: false

  - name: "Configuring GRUB cmdline"
    replace:
      path: '/etc/default/grub'
      regexp: '^GRUB_CMDLINE_LINUX_DEFAULT="((\w.?)*)"$'
      replace: 'GRUB_CMDLINE_LINUX_DEFAULT="\1 splash"'
    when: '"splash" not in grub_cfg_grep'

  - name: "Regenerate GRUB config"
    command: grub-mkconfig -o /boot/grub/grub.cfg

  - name: Configure security
    tags: security
    block:
    - name: Set unlock_time to 30s after the lock out.
      community.general.ini_file:
        path: /etc/security/faillock.conf
        section: null
        option: unlock_time
        value: 30
        exclusive: yes
    - name: Set fail_interval to 30s after N fail attempts
      community.general.ini_file:
        path: /etc/security/faillock.conf
        section: null
        option: fail_interval
        value: 30
        exclusive: yes
    - name: Set deny acesso to 6 consecutive authentication failures
      community.general.ini_file:
        path: /etc/security/faillock.conf
        section: null
        option: deny
        value: 6
        exclusive: yes
